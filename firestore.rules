/**
 * @description This ruleset enforces a strict user-ownership model for personal data,
 *              allows public read access to certain platform-wide content,
 *              and restricts write access based on ownership or role.
 * @dataStructure
 *  - User-specific data is nested under /users/{userId} for strict ownership.
 *  - Platform-wide data (courses, quests, study rooms, posts) resides in top-level collections.
 *  - Partner data is stored under /partners/{partnerId}.
 * @keySecurityDecisions
 *  - Users can only read/write their own data under /users/{userId}.
 *  - Listing of users is disallowed to protect privacy.
 *  - Public read access is granted to courses, quests, study rooms, and posts.
 *  - Partner-related data is accessible with appropriate partner ID.
 * @denormalizationForAuthorization
 *  - User profile data is stored in a subcollection named 'profile' under each user.
 * @structuralSegregation
 *  - Public content (posts, courses, quests, study-rooms) is stored in top-level collections,
 *    while private user data is stored under /users/{userId}.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requested user ID matches the authenticated user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

     /**
      * @description Checks if the requested user ID matches the authenticated user ID and that the resource exists.
      */
     function isExistingOwner(userId) {
       return isOwner(userId) && exists(resource);
     }

    /**
     * @description Rule for the /app-settings/economy document.
     * @path /app-settings/economy
     * @allow (get) - Any authenticated user can read the economy settings.
     * @deny (create, update, delete) - No one can create, update or delete the economy settings through client-side rules.
     * @principle Centralized configuration managed by backend functions.
     */
    match /app-settings/economy {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /app-settings/monetization/subscription-plans/{planId} document.
     * @path /app-settings/monetization/subscription-plans/{planId}
     * @allow (get, list) - Any authenticated user can read subscription plans.
     * @deny (create, update, delete) - No one can create, update or delete subscription plans through client-side rules.
     * @principle Centralized configuration managed by backend functions.
     */
    match /app-settings/monetization/subscription-plans/{planId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /app-settings/monetization/coin-bundles/{bundleId} document.
     * @path /app-settings/monetization/coin-bundles/{bundleId}
     * @allow (get, list) - Any authenticated user can read coin bundles.
     * @deny (create, update, delete) - No one can create, update or delete coin bundles through client-side rules.
     * @principle Centralized configuration managed by backend functions.
     */
    match /app-settings/monetization/coin-bundles/{bundleId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /quests/{questId} document.
     * @path /quests/{questId}
     * @allow (get, list) - Any user can read quests.
     * @deny (create, update, delete) - No one can create, update or delete quests through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /quests/{questId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /courses/{courseId} document.
     * @path /courses/{courseId}
     * @allow (get, list) - Any user can read courses.
     * @deny (create, update, delete) - No one can create, update or delete courses through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /courses/{courseId}/chapters/{chapterId} document.
     * @path /courses/{courseId}/chapters/{chapterId}
     * @allow (get, list) - Any user can read chapters within courses.
     * @deny (create, update, delete) - No one can create, update or delete chapters through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /courses/{courseId}/chapters/{chapterId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /courses/{courseId}/chapters/{chapterId}/lessons/{lessonId} document.
     * @path /courses/{courseId}/chapters/{chapterId}/lessons/{lessonId}
     * @allow (get, list) - Any user can read lessons within chapters.
     * @deny (create, update, delete) - No one can create, update or delete lessons through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /courses/{courseId}/chapters/{chapterId}/lessons/{lessonId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /users/{uid}/profile/{profileId} document.
     * @path /users/{uid}/profile/{profileId}
     * @allow (get, list) - Only the user can read their own profile.
     * @allow (create) - A user can create their own profile if the userId in the path matches their auth.
     * @allow (update, delete) - Only the user can update or delete their own profile and the document must exist.
     * @deny   (create) - A user cannot create a profile with an ID that does not match the authenticated user's ID.
     * @deny   (update) - A user cannot change their profile ID after creation.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/profile/{profileId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.auth.uid == profileId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{uid}/enrollments/{courseId} document.
     * @path /users/{uid}/enrollments/{courseId}
     * @allow (get, list) - Only the user can read their own enrollments.
     * @allow (create) - A user can create their own enrollment.
     * @allow (update, delete) - Only the user can update or delete their own enrollments.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/enrollments/{courseId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /users/{uid}/quest-progress/main document.
     * @path /users/{uid}/quest-progress/main
     * @allow (get, list) - Only the user can read their own quest progress.
     * @allow (create) - A user can create their own quest progress.
     * @allow (update, delete) - Only the user can update or delete their own quest progress.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/quest-progress/main {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /posts/{postId} document.
     * @path /posts/{postId}
     * @allow (get, list) - Any user can read posts.
     * @deny (create, update, delete) - No one can create, update or delete posts through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /posts/{postId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /users/{uid}/transactions/{transactionId} document.
     * @path /users/{uid}/transactions/{transactionId}
     * @allow (get, list) - Only the user can read their own transactions.
     * @allow (create) - A user can create their own transaction.
     * @allow (update, delete) - Only the user can update or delete their own transactions.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/transactions/{transactionId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rule for the /study-rooms/{roomId} document.
     * @path /study-rooms/{roomId}
     * @allow (get, list) - Any user can read study rooms.
     * @deny (create, update, delete) - No one can create, update or delete study rooms through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /study-rooms/{roomId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /contests/{contestId} document.
     * @path /contests/{contestId}
     * @allow (get, list) - Any user can read contests.
     * @deny (create, update, delete) - No one can create, update or delete contests through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /contests/{contestId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /users/{uid}/coupons/{couponId} document.
     * @path /users/{uid}/coupons/{couponId}
     * @allow (get, list) - Only the user can read their own coupons.
     * @allow (create) - A user can create their own coupon.
     * @allow (update, delete) - Only the user can update or delete their own coupons.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/coupons/{couponId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

   /**
     * @description Rule for the /partners/{partnerId} document.
     * @path /partners/{partnerId}
     * @allow (get, list) - Any user can read partner data.
     * @deny (create, update, delete) - No one can create, update or delete partner data through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /partners/{partnerId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /partners/{partnerId}/courses/{courseId} document.
     * @path /partners/{partnerId}/courses/{courseId}
     * @allow (get, list) - Any user can read courses offered by a specific partner.
     * @deny (create, update, delete) - No one can create, update or delete courses offered by a specific partner through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /partners/{partnerId}/courses/{courseId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /partners/{partnerId}/products/{productId} document.
     * @path /partners/{partnerId}/products/{productId}
     * @allow (get, list) - Any user can read products offered by a specific partner.
     * @deny (create, update, delete) - No one can create, update or delete products offered by a specific partner through client-side rules.
     * @principle Public read, admin-only write.
     */
    match /partners/{partnerId}/products/{productId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /partner-applications/{applicationId} document.
     * @path /partner-applications/{applicationId}
     * @allow (create) - Any authenticated user can create a partner application.
     * @deny (get, list, update, delete) - No one can get, list, update or delete partner applications through client-side rules.
     * @principle Restricted access, application creation allowed.
     */
    match /partner-applications/{applicationId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rule for the /users/{userId}/profile collection group to solve the search action error reported in the prompt.
     * @path /users/{userId}/profile
     * @allow list: if false - No one can list users in the database due to security reasons
     * @allow get: if isOwner(userId)
     * @allow create: if false
     * @allow update: if false
     * @allow delete: if false
     * @principle Public read, admin-only write.
     */
    match /users/{userId}/profile/{profileId} {
        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}