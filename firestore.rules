/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user-specific data and allows public read access for certain collections.
 *
 * Data Structure:
 * - User-specific data is nested under /users/{userId}.
 * - Public data (courses, quests, posts, study rooms, contests, partners, partner applications) resides in top-level collections.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data, enrollments, quest progress, transactions, and coupons.
 * - Listing of user transactions and coupons is allowed only for the owner.
 * - Courses, Quests, Posts, Study Rooms, Contests, and Partners are publicly readable, but write access is not defined and should be implemented with owner validation using an ownership field.
 * - Partner Applications are publicly readable, but write access is not defined.
 * - Economy settings, subscription plans, and coin bundles are publicly readable.
 *
 * Note: All write operations require authentication.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the current user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the requesting user is the owner of the document.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the requesting user is the owner of the document and the resource exists.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
    
    /**
     * @description Rules for app settings related to the economy.
     * @path /app-settings/economy
     * @allow (get, list): All users can read economy settings.
     * @deny (create, update, delete): No user can create, update, or delete economy settings through the client.
     * @principle Public read, admin-only write (backend managed).
     */
    match /app-settings/economy {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for subscription plans.
     * @path /app-settings/monetization/subscription-plans/{planId}
     * @allow (get, list): All users can read subscription plans.
     * @deny (create, update, delete): No user can create, update, or delete subscription plans through the client.
     * @principle Public read, admin-only write (backend managed).
     */
    match /app-settings/monetization/subscription-plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for coin bundles.
     * @path /app-settings/monetization/coin-bundles/{bundleId}
     * @allow (get, list): All users can read coin bundles.
     * @deny (create, update, delete): No user can create, update, or delete coin bundles through the client.
     * @principle Public read, admin-only write (backend managed).
     */
    match /app-settings/monetization/coin-bundles/{bundleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for quests.
     * @path /quests/{questId}
     * @allow (get, list): All users can read quests.
     * @deny (create, update, delete): No user can create, update, or delete quests through the client.
     * @principle Public read, admin-only write (backend managed).
     */
    match /quests/{questId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for courses.
     * @path /courses/{courseId}
     * @allow (get, list): All users can read courses.
     * @deny (create, update, delete): No user can create, update, or delete courses through the client.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false; 
    }

    /**
     * @description Rules for chapters within a course.
     * @path /courses/{courseId}/chapters/{chapterId}
     * @allow (get, list): All users can read chapters.
     * @deny (create, update, delete): No user can create, update, or delete chapters through the client.
     */
    match /courses/{courseId}/chapters/{chapterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for lessons within a chapter.
     * @path /courses/{courseId}/chapters/{chapterId}/lessons/{lessonId}
     * @allow (get, list): All users can read lessons.
     * @deny (create, update, delete): No user can create, update, or delete lessons through the client.
     */
    match /courses/{courseId}/chapters/{chapterId}/lessons/{lessonId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}/profile/{profileId}
     * @allow (get, list): Users can read their own profile.
     * @allow (create): Users can create their own profile with a matching user ID.
     * @allow (update, delete): Users can update/delete their own profile.
     * @deny create: if request.resource.data.id != userId;
     * @deny update: if request.resource.data.id != resource.data.id;
     * @principle Enforces document ownership.
     */
    match /users/{userId}/profile/{profileId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for user enrollments.
     * @path /users/{userId}/enrollments/{courseId}
     * @allow (get, list): Users can read their own enrollments.
     * @allow (create, update, delete): Users can create, update, and delete their own enrollments.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/enrollments/{courseId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for user quest progress.
     * @path /users/{userId}/quest-progress/main
     * @allow (get, list): Users can read their own quest progress.
     * @allow (create, update, delete): Users can create, update, and delete their own quest progress.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/quest-progress/main {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for social posts.
     * @path /posts/{postId}
     * @allow (get, list): All users can read social posts.
     * @deny (create, update, delete): No user can create, update, or delete posts through the client.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

   /**
     * @description Rules for user transactions.
     * @path /users/{userId}/transactions/{transactionId}
     * @allow (get, list): Users can read their own transactions.
     * @allow (create): Users can create their own transactions.
     * @deny (update, delete): Users cannot update or delete transactions.
     * @principle Enforces document ownership.
     */
    match /users/{userId}/transactions/{transactionId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if false;
    }

    /**
     * @description Rules for study rooms.
     * @path /study-rooms/{roomId}
     * @allow (get, list): All users can read study rooms.
     * @deny (create, update, delete): No user can create, update, or delete study rooms through the client.
     */
    match /study-rooms/{roomId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Rules for contests.
     * @path /contests/{contestId}
     * @allow (get, list): All users can read contests.
     * @deny (create, update, delete): No user can create, update, or delete contests through the client.
     */
    match /contests/{contestId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for coupons awarded to a specific user.
     * @path /users/{userId}/coupons/{couponId}
     * @allow (get, list): Only the user can read their own coupons.
     * @allow create: if isOwner(userId);
     * @deny (update, delete): Users cannot update or delete coupons.
     */
    match /users/{userId}/coupons/{couponId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update, delete: if false;
    }

    /**
     * @description Rules for partner organizations.
     * @path /partners/{partnerId}
     * @allow (get, list): All users can read partner organizations.
     * @deny (create, update, delete): No user can create, update, or delete partners through the client.
     */
    match /partners/{partnerId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

   /**
     * @description Rules for courses offered by a specific partner.
     * @path /partners/{partnerId}/courses/{courseId}
     * @allow (get, list): All users can read courses offered by partners.
     * @deny (create, update, delete): No user can create, update, or delete partner courses through the client.
     */
    match /partners/{partnerId}/courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for products and services offered by a specific partner.
     * @path /partners/{partnerId}/products/{productId}
     * @allow (get, list): All users can read products offered by partners.
     * @deny (create, update, delete): No user can create, update, or delete partner products through the client.
     */
    match /partners/{partnerId}/products/{productId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Rules for partner applications.
     * @path /partner-applications/{applicationId}
     * @allow (get, list): All users can read partner applications.
     * @deny (create, update, delete): No user can create, update, or delete partner applications through the client.
     */
    match /partner-applications/{applicationId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}