/**
 * @file Firestore Security Rules
 * @core-philosophy This ruleset enforces a combination of public read access for certain collections (e.g., courses, posts, study rooms) and user-based ownership for user-specific data (e.g., user profiles, enrollments, transactions).
 * Super admin status is not considered in the current rules.
 * @data-structure
 * - `/app-settings`: Contains singleton documents related to app configuration.
 * - `/quests`: Contains data for quests available in the Brain Quest Adventure.
 * - `/courses`: Contains information about courses. Courses have subcollections for chapters and lessons.
 * - `/users`: User-specific data is stored under a user's UID.
 * - `/posts`: Contains social posts.
 * - `/study-rooms`: Contains information about study rooms.
 * - `/contests`: Contains data for platform-wide contests.
 * - `/partners`: Contains information about partner organizations. Partners have subcollections for courses and products.
 * - `/partner-applications`: Contains applications from potential partners.
 * @key-security-decisions
 * - Public Read Access: Collections like `/courses`, `/posts`, and `/study-rooms` are publicly readable. This simplifies data access for common use cases like browsing available courses or viewing the social feed.
 * - Strict User Ownership: User profiles and other user-specific data are strictly controlled by the user's UID. Only the authenticated user can create, read, update, or delete their own data.
 * - No User Listing: Listing all users is explicitly denied. This protects user privacy and prevents unauthorized access to user data.
 * - Partner Access: Partner data is publicly readable, but creation and modification are not covered in this initial ruleset and would need specific admin or partner role management.
 * @denormalization-for-authorization
 * - Posts should include the author's UID to enable ownership checks for updates and deletes.
 * - Courses should include an instructorId to enable instructor-based management.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows read-only access to app economy settings.
     * @path /app-settings/economy
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to economy settings.
     */
    match /app-settings/economy {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read-only access to subscription plans.
     * @path /app-settings/monetization/subscription-plans/{planId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to subscription plans.
     */
    match /app-settings/monetization/subscription-plans/{planId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read-only access to coin bundles.
     * @path /app-settings/monetization/coin-bundles/{bundleId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to coin bundles.
     */
    match /app-settings/monetization/coin-bundles/{bundleId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows read-only access to quests.
     * @path /quests/{questId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to quests.
     */
    match /quests/{questId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to courses.
     * @path /courses/{courseId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to course information.
     */
    match /courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to course chapters.
     * @path /courses/{courseId}/chapters/{chapterId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to chapter information for courses.
     */
    match /courses/{courseId}/chapters/{chapterId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to lessons within chapters.
     * @path /courses/{courseId}/chapters/{chapterId}/lessons/{lessonId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to lesson information for courses.
     */
    match /courses/{courseId}/chapters/{chapterId}/lessons/{lessonId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for profile data.
     * @path /users/{userId}/profile/{profileId}
     * @allow (create) User can create their own profile.
     * @allow (get, list, update, delete) User can only access their own profile.
     * @deny (create) Another user cannot create a profile for someone else.
     * @deny (get, list, update, delete) Another user cannot access someone else's profile.
     * @principle Enforces document ownership for profile writes.
     */
    match /users/{userId}/profile/{profileId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for course enrollments.
     * @path /users/{userId}/enrollments/{courseId}
     * @allow (create) User can create their own enrollment.
     * @allow (get, list, update, delete) User can only access their own enrollments.
     * @deny (create) Another user cannot create an enrollment for someone else.
     * @deny (get, list, update, delete) Another user cannot access someone else's enrollments.
     * @principle Enforces document ownership for enrollment writes.
     */
    match /users/{userId}/enrollments/{courseId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces user-ownership for quest progress.
     * @path /users/{userId}/quest-progress/main
     * @allow (create) User can create their own quest progress.
     * @allow (get, list, update, delete) User can only access their own quest progress.
     * @deny (create) Another user cannot create quest progress for someone else.
     * @deny (get, list, update, delete) Another user cannot access someone else's quest progress.
     * @principle Enforces document ownership for quest progress writes.
     */
    match /users/{userId}/quest-progress/main {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to posts. Owner can update/delete.
     * @path /posts/{postId}
     * @allow (get, list) Any authenticated user.
     * @allow (create) Any authenticated user can create a post.
     * @deny (update, delete) Only the owner can update/delete a post.
     * @principle Allows public access to posts, but enforces ownership for writes.
     */
    match /posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isExistingOwner(resource.data.author.uid);
      allow delete: if isExistingOwner(resource.data.author.uid);
    }

    /**
     * @description Enforces user-ownership for transactions.
     * @path /users/{userId}/transactions/{transactionId}
     * @allow (create) User can create their own transaction.
     * @allow (get, list, update, delete) User can only access their own transactions.
     * @deny (create) Another user cannot create a transaction for someone else.
     * @deny (get, list, update, delete) Another user cannot access someone else's transactions.
     * @principle Enforces document ownership for transaction writes.
     */
    match /users/{userId}/transactions/{transactionId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to study rooms.
     * @path /study-rooms/{roomId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to study room information.
     */
    match /study-rooms/{roomId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to contests.
     * @path /contests/{contestId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to contest information.
     */
    match /contests/{contestId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for coupons.
     * @path /users/{userId}/coupons/{couponId}
     * @allow (create) User can create their own coupon.
     * @allow (get, list, update, delete) User can only access their own coupons.
     * @deny (create) Another user cannot create a coupon for someone else.
     * @deny (get, list, update, delete) Another user cannot access someone else's coupons.
     * @principle Enforces document ownership for coupon writes.
     */
    match /users/{userId}/coupons/{couponId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to partner organizations.
     * @path /partners/{partnerId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to partner information.
     */
    match /partners/{partnerId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to partner courses.
     * @path /partners/{partnerId}/courses/{courseId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to partner course information.
     */
    match /partners/{partnerId}/courses/{courseId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to partner products.
     * @path /partners/{partnerId}/products/{productId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to partner product information.
     */
     match /partners/{partnerId}/products/{productId} {
        allow get, list: if true;
        allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to partner applications.
     * @path /partner-applications/{applicationId}
     * @allow (get, list) Any authenticated user.
     * @deny (create, update, delete) No one.
     * @principle Allows public access to partner application information.
     */
    match /partner-applications/{applicationId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    // --- Helper functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}