rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    function isExistingOwner(uid) {
      return isOwner(uid) && resource.data.id == uid;
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    // App Settings: Admins should manage this, but for now allow authenticated read
    match /app-settings/{document=**} {
      allow read: if isAuthenticated();
      allow write: if false; // Protect settings
    }
    
    // Users: Public profile is readable, but only owner can write.
    match /users/{uid} {
      allow read, write: if isOwner(uid);
    }

    match /users/{uid}/profile/{profileId} {
      allow get: if isAuthenticated();
      allow list, create, update, delete: if isOwner(uid);
    }
    
    // User-specific subcollections can only be accessed by the owner
    match /users/{uid}/{collection}/{docId} {
      allow read, write: if isOwner(uid);
    }

    // Public Collections: Readable by any authenticated user
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      // Only the instructor can create/update the course
      allow write: if isAuthenticated() && request.auth.uid == resource.data.instructorId;
      
      match /chapters/{chapterId} {
        allow read: if isAuthenticated();
        // Check instructorId on the parent course for chapter writes
        allow write: if isAuthenticated() && get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid;
        
        match /lessons/{lessonId} {
           allow read: if isAuthenticated();
           allow write: if isAuthenticated() && get(/databases/$(database)/documents/courses/$(courseId)).data.instructorId == request.auth.uid;
        }
      }
    }

    match /posts/{postId} {
      allow read: if isAuthenticated();
      // Allow create for any authenticated user
      allow create: if isAuthenticated() && request.resource.data.authorUid == request.auth.uid;
      // Allow update/delete only for the post author
      allow update, delete: if isAuthenticated() && resource.data.authorUid == request.auth.uid;
    }
    
    match /quests/{questId} {
      allow read: if isAuthenticated();
      allow write: if false; // Should be managed by admins
    }
    
    match /study-rooms/{roomId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && request.resource.data.hostId == request.auth.uid;
        allow update: if isAuthenticated() && resource.data.hostId == request.auth.uid;
    }

    match /contests/{contestId} {
        allow read: if isAuthenticated();
        allow write: if false; // Should be managed by admins
    }

    // Partners: Publicly readable
    match /partners/{partnerId} {
      allow read: if isAuthenticated();
      allow write: if false; // Should be managed by admins

      match /{collection}/{docId} {
        allow read: if isAuthenticated();
        allow write: if false; // Should be managed by admins
      }
    }
    
    // Partner Applications: Users can create their own application
    match /partner-applications/{applicationId} {
        allow read: if isAuthenticated(); // Allow admins/users to read applications
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if false; // Managed by backend/admins
    }
    
     // Chat: Participants can read/write messages
    match /chats/{chatId} {
      allow read, update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      
      match /messages/{messageId} {
        allow read, create: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
  }
}
